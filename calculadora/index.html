<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Mi Inventario CS2</title>
    <style>
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background-color: #1b2838;
            color: #c7d5e0;
            margin: 0;
            padding: 20px;
            display: flex;
            flex-direction: column;
            align-items: center;
        }
        h1 { color: #66c0f4; }
        
        .controls {
            margin-bottom: 20px;
            width: 100%;
            max-width: 900px;
            display: flex;
            justify-content: flex-end;
        }

        button.refresh-btn {
            background: linear-gradient(90deg, #47bfff 0%, #1a9fff 100%);
            border: none;
            color: white;
            padding: 10px 20px;
            border-radius: 4px;
            cursor: pointer;
            font-weight: bold;
            font-size: 1rem;
        }
        button.refresh-btn:hover { opacity: 0.9; }

        .inventory-table {
            width: 100%;
            max-width: 900px;
            border-collapse: collapse;
            background-color: #171a21;
            box-shadow: 0 4px 15px rgba(0,0,0,0.5);
            border-radius: 8px;
            overflow: hidden;
        }

        th, td {
            padding: 15px;
            text-align: left;
            border-bottom: 1px solid #2a475e;
        }

        th {
            background-color: #2a475e;
            color: #66c0f4;
            text-transform: uppercase;
            font-size: 0.85rem;
        }

        /* Inputs dentro de la tabla */
        input {
            background-color: #0d1015;
            border: 1px solid #4a6680;
            color: white;
            padding: 8px;
            width: 80px;
            border-radius: 4px;
            text-align: center;
        }
        input:focus { outline: none; border-color: #66c0f4; }

        .profit-positive { color: #4caf50; font-weight: bold; }
        .profit-negative { color: #f44336; font-weight: bold; }
        .loading-text { color: #f0ad4e; font-size: 0.9rem; }

        .summary-bar {
            position: fixed;
            bottom: 0;
            left: 0;
            width: 100%;
            background-color: #101216;
            padding: 15px;
            display: flex;
            justify-content: center;
            gap: 30px;
            border-top: 2px solid #66c0f4;
            font-size: 1.2rem;
        }
    </style>
</head>
<body>

    <h1>Mi Cartera de Skins</h1>

    <div class="controls">
        <button class="refresh-btn" onclick="actualizarPrecios()">ðŸ”„ Actualizar Precios Mercado</button>
    </div>

    <table class="inventory-table">
        <thead>
            <tr>
                <th style="width: 30%">Skin</th>
                <th>Cantidad</th>
                <th>Compra Unit. (â‚¬)</th>
                <th>Precio Mercado</th>
                <th>Beneficio Total</th>
            </tr>
        </thead>
        <tbody id="inventory-body">
            </tbody>
    </table>

    <div style="height: 80px;"></div> <div class="summary-bar">
        <div>InversiÃ³n: <span id="total-invested">0.00â‚¬</span></div>
        <div>Valor Actual (Neto): <span id="total-value">0.00â‚¬</span></div>
        <div>Profit Total: <span id="total-profit">0.00â‚¬</span></div>
    </div>

<script>
    // --- 1. CONFIGURACIÃ“N: AÃ‘ADE AQUÃ TUS SKINS ---
    // Debes poner el nombre exacto de mercado (Market Hash Name)
    const misSkins = [
        { nombre: "Dreams and Nightmares", hash: "Dreams & Nightmares Case" },
        { nombre: "Fracture", hash: "Fracture Case" },
        { nombre: "Revolution", hash: "Revolution Case" },
        { nombre: "Snakebite", hash: "Snakebite Case" }
    ];

    // Cargar datos guardados al iniciar
    const savedData = JSON.parse(localStorage.getItem('cs_inventory_data')) || {};

    const tableBody = document.getElementById('inventory-body');

    // --- 2. GENERAR TABLA INICIAL ---
    function initTable() {
        tableBody.innerHTML = '';
        
        misSkins.forEach((skin, index) => {
            // Recuperar datos guardados o poner 0 por defecto
            const saved = savedData[skin.hash] || { qty: 0, buyPrice: 0 };
            
            const row = document.createElement('tr');
            row.innerHTML = `
                <td>
                    <strong>${skin.nombre}</strong><br>
                    <span style="font-size:0.75rem; color:#8f98a0;">${skin.hash}</span>
                </td>
                <td>
                    <input type="number" value="${saved.qty}" min="0" 
                        onchange="saveInput('${skin.hash}', 'qty', this.value)">
                </td>
                <td>
                    <input type="number" value="${saved.buyPrice}" step="0.01" min="0" 
                        onchange="saveInput('${skin.hash}', 'buyPrice', this.value)">
                </td>
                <td id="price-${index}" class="market-price">---</td>
                <td id="profit-${index}">---</td>
            `;
            tableBody.appendChild(row);
        });
        
        calcularTotales(); // Calcular con los datos que ya tenemos guardados (aunque falte precio mercado)
    }

    // --- 3. GUARDAR DATOS (LocalStorage) ---
    function saveInput(hash, field, value) {
        if (!savedData[hash]) savedData[hash] = {};
        savedData[hash][field] = parseFloat(value) || 0;
        
        localStorage.setItem('cs_inventory_data', JSON.stringify(savedData));
        calcularTotales(); // Recalcular al cambiar inputs
    }

// --- 4. LLAMAR A LA API (Actualizar precios) ---
    async function actualizarPrecios() {
        // Poner estado de carga visual
        misSkins.forEach((_, index) => {
            const celda = document.getElementById(`price-${index}`);
            if(celda) celda.innerHTML = '<span class="loading-text">Cargando...</span>';
        });

        // Recorremos las skins y pedimos precio
        // CORRECCIÃ“N: Ahora usamos 'i' consistentemente
        for (let i = 0; i < misSkins.length; i++) {
            const skin = misSkins[i];
            try {
                // Llamada a TU backend en Vercel
                const res = await fetch(`/api/price?skin=${encodeURIComponent(skin.hash)}`);
                const data = await res.json();
                
                const celdaPrecio = document.getElementById(`price-${i}`); // AquÃ­ usamos 'i'
                
                if (data.lowest_price) {
                    // Limpiar el precio (quitar â‚¬ o $ y convertir a nÃºmero)
                    let priceClean = parseFloat(data.lowest_price.replace(/[^\d,.-]/g, '').replace(',','.'));
                    
                    // Guardamos el precio actual
                    celdaPrecio.dataset.price = priceClean;
                    celdaPrecio.innerText = `${priceClean.toFixed(2)}â‚¬`;
                } else {
                    celdaPrecio.innerText = "Error";
                }
            } catch (e) {
                console.error(e);
                // Si falla, mostramos error en la celda correcta usando 'i'
                document.getElementById(`price-${i}`).innerText = "FallÃ³";
            }
        }
        calcularTotales();
    }

    // --- 5. CÃLCULOS MATEMÃTICOS ---
    function calcularTotales() {
        let totalInvested = 0;
        let totalNetValue = 0;

        misSkins.forEach((skin, index) => {
            const saved = savedData[skin.hash] || { qty: 0, buyPrice: 0 };
            const currentPriceCell = document.getElementById(`price-${index}`);
            const profitCell = document.getElementById(`profit-${index}`);
            
            // Si aun no hemos descargado el precio, usamos 0 para calcular (o el Ãºltimo conocido si quisieras mejorarlo)
            const currentPrice = parseFloat(currentPriceCell.dataset.price) || 0;

            const invested = saved.qty * saved.buyPrice;
            
            // Steam Fee: 15% (recibes el 0.85)
            const revenueNet = (currentPrice * saved.qty) * 0.85;
            const profit = revenueNet - invested;

            // Totales globales
            totalInvested += invested;
            if (currentPrice > 0) totalNetValue += revenueNet;

            // Actualizar celda de beneficio individual
            if (currentPrice > 0) {
                profitCell.innerText = `${profit > 0 ? '+' : ''}${profit.toFixed(2)}â‚¬`;
                profitCell.className = profit > 0 ? 'profit-positive' : 'profit-negative';
            }
        });

        // Actualizar barra inferior
        document.getElementById('total-invested').innerText = `${totalInvested.toFixed(2)}â‚¬`;
        document.getElementById('total-value').innerText = `${totalNetValue.toFixed(2)}â‚¬`;
        
        const totalProfit = totalNetValue - totalInvested;
        const totalSpan = document.getElementById('total-profit');
        totalSpan.innerText = `${totalProfit > 0 ? '+' : ''}${totalProfit.toFixed(2)}â‚¬`;
        totalSpan.style.color = totalProfit >= 0 ? '#4caf50' : '#f44336';
    }

    // Iniciar la tabla al cargar la pÃ¡gina
    initTable();
</script>

</body>
</html>


