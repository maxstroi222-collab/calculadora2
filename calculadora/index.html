<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>CS2 Skin Tracker PRO</title>
    <style>
        /* ESTILOS GENERALES */
        body { font-family: 'Segoe UI', sans-serif; background-color: #1b2838; color: #c7d5e0; margin: 0; padding: 20px; display: flex; flex-direction: column; align-items: center; }
        h1 { color: #66c0f4; }
        button { cursor: pointer; border: none; border-radius: 4px; padding: 10px 15px; font-weight: bold; }
        input { background-color: #0d1015; border: 1px solid #4a6680; color: white; padding: 8px; border-radius: 4px; }

        /* VISTAS (LOGIN VS APP) */
        #auth-container, #app-container { width: 100%; max-width: 900px; display: none; }
        .active-view { display: block !important; }

        /* AUTH STYLES */
        .auth-box { background: #171a21; padding: 40px; border-radius: 8px; text-align: center; max-width: 400px; margin: 50px auto; box-shadow: 0 4px 15px rgba(0,0,0,0.5); }
        .auth-box input { width: 90%; margin-bottom: 15px; display: block; margin: 10px auto; }
        .auth-btn { background: linear-gradient(90deg, #47bfff 0%, #1a9fff 100%); color: white; width: 100%; }

        /* APP CONTROLS */
        .top-bar { display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; }
        .refresh-btn { background: #4caf50; color: white; }
        .logout-btn { background: #d9534f; color: white; font-size: 0.8rem; }

        /* TABLA */
        .inventory-table { width: 100%; border-collapse: collapse; background-color: #171a21; border-radius: 8px; overflow: hidden; margin-bottom: 100px; }
        th, td { padding: 15px; text-align: left; border-bottom: 1px solid #2a475e; }
        th { background-color: #2a475e; color: #66c0f4; }
        
        .profit-positive { color: #4caf50; font-weight: bold; }
        .profit-negative { color: #f44336; font-weight: bold; }

        /* ADMIN PANEL */
        #admin-panel { background: #2a2d33; padding: 15px; margin-bottom: 20px; border-left: 4px solid #f0ad4e; display: none; }
        .admin-controls { display: flex; gap: 10px; margin-top: 10px; }
        .delete-btn { background: #c9302c; color: white; padding: 5px 10px; font-size: 0.8rem; }

        /* SUMMARY BAR */
        .summary-bar { position: fixed; bottom: 0; left: 0; width: 100%; background-color: #101216; padding: 15px; display: flex; justify-content: center; gap: 30px; border-top: 2px solid #66c0f4; font-size: 1.2rem; z-index: 100; }
    </style>
</head>
<body>

    <div id="auth-container">
        <div class="auth-box">
            <h2>Bienvenido</h2>
            <input type="email" id="email" placeholder="Correo electrÃ³nico">
            <input type="password" id="password" placeholder="ContraseÃ±a">
            <button class="auth-btn" onclick="handleLogin()">Iniciar SesiÃ³n</button>
            <button class="auth-btn" style="background: transparent; border: 1px solid #47bfff; margin-top: 10px;" onclick="handleRegister()">Registrarse</button>
            <p id="auth-msg" style="color: #f44336; margin-top: 10px;"></p>
        </div>
    </div>

    <div id="app-container">
        <div class="top-bar">
            <h1>Mi Cartera CS2</h1>
            <div>
                <span id="user-email" style="margin-right: 15px; color: #8f98a0;"></span>
                <button class="logout-btn" onclick="handleLogout()">Salir</button>
            </div>
        </div>

        <div id="admin-panel">
            <h3>ðŸ›  Panel Administrador</h3>
            <div class="admin-controls">
                <input type="text" id="new-skin-name" placeholder="Nombre (ej: Revolution)">
                <input type="text" id="new-skin-hash" placeholder="Market Hash (ej: Revolution Case)">
                <button onclick="adminAddSkin()" style="background: #f0ad4e; color: black;">+ AÃ±adir Skin Global</button>
            </div>
        </div>

        <div style="display: flex; justify-content: flex-end; margin-bottom: 10px;">
            <button class="refresh-btn" onclick="actualizarPrecios()">ðŸ”„ Actualizar Mercado</button>
        </div>

        <table class="inventory-table">
            <thead>
                <tr>
                    <th style="width: 35%">Skin</th>
                    <th>Cantidad</th>
                    <th>Compra Unit.</th>
                    <th>Precio Mercado</th>
                    <th>Beneficio</th>
                    <th class="admin-only" style="display:none;">AcciÃ³n</th>
                </tr>
            </thead>
            <tbody id="inventory-body"></tbody>
        </table>

        <div class="summary-bar">
            <div>Inv: <span id="total-invested">0.00â‚¬</span></div>
            <div>Valor: <span id="total-value">0.00â‚¬</span></div>
            <div>Profit: <span id="total-profit">0.00â‚¬</span></div>
        </div>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/9.23.0/firebase-app.js";
        import { getAuth, createUserWithEmailAndPassword, signInWithEmailAndPassword, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/9.23.0/firebase-auth.js";
        import { getFirestore, doc, getDoc, setDoc, updateDoc, arrayUnion, arrayRemove, collection, getDocs, addDoc, deleteDoc } from "https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore.js";

        // --- 1. PEGA AQUÃ TU CONFIGURACIÃ“N DE FIREBASE ---
        const firebaseConfig = {
            apiKey: "AIzaSyDTrzjZAnrRhfWyJSBXnmPnc5cVMHhZPy0",
            authDomain: "calculadora2-a85c3.firebaseapp.com",
            projectId: "calculadora2-a85c3",
            storageBucket: "calculadora2-a85c3.firebasestorage.app",
            messagingSenderId: "1031799067800",
            appId: "1:1031799067800:web:2dbe67122cccf855e76ced",
            measurementId: "G-WE2ER7DP5K"
        };

        // Inicializar Firebase
        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);

        // Variables Globales
        let currentUser = null;
        let globalSkins = []; // Lista de skins cargada desde BD
        let userData = {};    // Inventario del usuario

        // Email del Administrador (PON AQUÃ TU EMAIL PARA VER EL PANEL)
        const ADMIN_EMAIL = "maksympavelko98@gmail.com"; 

        // --- 2. GESTIÃ“N DE AUTENTICACIÃ“N ---
        window.handleLogin = async () => {
            const email = document.getElementById('email').value;
            const pass = document.getElementById('password').value;
            try {
                await signInWithEmailAndPassword(auth, email, pass);
            } catch (e) { document.getElementById('auth-msg').innerText = "Error: " + e.message; }
        };

        window.handleRegister = async () => {
            const email = document.getElementById('email').value;
            const pass = document.getElementById('password').value;
            try {
                await createUserWithEmailAndPassword(auth, email, pass);
            } catch (e) { document.getElementById('auth-msg').innerText = "Error: " + e.message; }
        };

        window.handleLogout = () => signOut(auth);

// Escuchar cambios de sesiÃ³n
        onAuthStateChanged(auth, async (user) => {
            if (user) {
                currentUser = user;
                document.getElementById('user-email').innerText = user.email;
                document.getElementById('auth-container').classList.remove('active-view');
                document.getElementById('app-container').classList.add('active-view');
                
                // --- CORRECCIÃ“N DE SEGURIDAD VISUAL ---
                const adminPanel = document.getElementById('admin-panel');
                const adminColumns = document.querySelectorAll('.admin-only');

                if(user.email === ADMIN_EMAIL) {
                    // SI ERES ADMIN: Mostramos todo
                    adminPanel.style.display = 'block';
                    adminColumns.forEach(el => el.style.display = 'table-cell');
                } else {
                    // SI NO ERES ADMIN: Ocultamos todo explÃ­citamente
                    // (Esto borra el rastro si antes entrÃ³ un admin)
                    adminPanel.style.display = 'none';
                    adminColumns.forEach(el => el.style.display = 'none');
                }
                // --------------------------------------

                await cargarDatosIniciales();
            } else {
                currentUser = null;
                document.getElementById('app-container').classList.remove('active-view');
                document.getElementById('auth-container').classList.add('active-view');
                
                // Opcional: Limpiar la tabla al salir para que no se vea nada brevemente al volver a entrar
                document.getElementById('inventory-body').innerHTML = '';
            }
        });

        // --- 3. LÃ“GICA DE DATOS (BD) ---
        
        // Cargar skins globales y datos del usuario
        async function cargarDatosIniciales() {
            // 1. Cargar lista de skins (Global)
            const querySnapshot = await getDocs(collection(db, "skins"));
            globalSkins = [];
            querySnapshot.forEach((doc) => {
                globalSkins.push({ id: doc.id, ...doc.data() });
            });

            // 2. Cargar inventario del usuario (Personal)
            const userDocRef = doc(db, "users", currentUser.uid);
            const userSnap = await getDoc(userDocRef);
            
            if (userSnap.exists()) {
                userData = userSnap.data().inventory || {};
            } else {
                userData = {}; // Usuario nuevo
            }

            renderTable();
        }

        // --- 4. RENDERIZADO DE TABLA ---
        function renderTable() {
            const tbody = document.getElementById('inventory-body');
            tbody.innerHTML = '';

            globalSkins.forEach((skin, index) => {
                const saved = userData[skin.hash] || { qty: 0, buyPrice: 0 };
                const isAdmin = currentUser && currentUser.email === ADMIN_EMAIL;

                const row = document.createElement('tr');
                row.innerHTML = `
                    <td>
                        <strong>${skin.nombre}</strong><br>
                        <span style="font-size:0.75rem; color:#8f98a0;">${skin.hash}</span>
                    </td>
                    <td>
                        <input type="number" value="${saved.qty}" min="0" style="width:60px"
                            onchange="window.saveInput('${skin.hash}', 'qty', this.value)">
                    </td>
                    <td>
                        <input type="number" value="${saved.buyPrice}" step="0.01" min="0" style="width:70px"
                            onchange="window.saveInput('${skin.hash}', 'buyPrice', this.value)">
                    </td>
                    <td id="price-${index}" class="market-price" data-hash="${skin.hash}">---</td>
                    <td id="profit-${index}">---</td>
                    ${isAdmin ? `<td><button class="delete-btn" onclick="window.adminDeleteSkin('${skin.id}')">X</button></td>` : ''}
                `;
                tbody.appendChild(row);
            });
            calcularTotales();
        }

        // --- 5. GUARDAR DATOS DE USUARIO ---
        window.saveInput = async (hash, field, value) => {
            if (!userData[hash]) userData[hash] = { qty: 0, buyPrice: 0 };
            userData[hash][field] = parseFloat(value) || 0;

            // Guardar en Firestore
            try {
                const userDocRef = doc(db, "users", currentUser.uid);
                await setDoc(userDocRef, { inventory: userData }, { merge: true });
                calcularTotales();
            } catch (e) { console.error("Error guardando:", e); }
        };

        // --- 6. FUNCIONES DE ADMIN ---
        window.adminAddSkin = async () => {
            const nombre = document.getElementById('new-skin-name').value;
            const hash = document.getElementById('new-skin-hash').value;
            
            if(!nombre || !hash) return alert("Rellena ambos campos");

            try {
                await addDoc(collection(db, "skins"), { nombre, hash });
                document.getElementById('new-skin-name').value = '';
                document.getElementById('new-skin-hash').value = '';
                await cargarDatosIniciales(); // Recargar tabla
            } catch (e) { alert("Error aÃ±adiendo skin: " + e.message); }
        };

        window.adminDeleteSkin = async (docId) => {
            if(confirm("Â¿Seguro que quieres borrar esta skin para todos?")) {
                try {
                    await deleteDoc(doc(db, "skins", docId));
                    await cargarDatosIniciales();
                } catch(e) { alert("Error: " + e.message); }
            }
        };

        // --- 7. ACTUALIZAR PRECIOS (TU API VERCEL) ---
        window.actualizarPrecios = async () => {
            const pricesCells = document.querySelectorAll('.market-price');
            pricesCells.forEach(cell => cell.innerHTML = '<span style="color:#f0ad4e">Cargando...</span>');

            for (let i = 0; i < globalSkins.length; i++) {
                const skin = globalSkins[i];
                const celda = document.getElementById(`price-${i}`);
                
                try {
                    const res = await fetch(`/api/price?skin=${encodeURIComponent(skin.hash)}`);
                    const data = await res.json();
                    
                    if (data.lowest_price) {
                        let priceClean = parseFloat(data.lowest_price.replace(/[^\d,.-]/g, '').replace(',','.'));
                        celda.dataset.price = priceClean;
                        celda.innerText = `${priceClean.toFixed(2)}â‚¬`;
                    } else {
                        celda.innerText = "N/A";
                    }
                } catch (e) {
                    celda.innerText = "Err";
                }
            }
            calcularTotales();
        }

        // --- 8. CÃLCULOS ---
        function calcularTotales() {
            let totalInvested = 0;
            let totalNetValue = 0;

            globalSkins.forEach((skin, index) => {
                const saved = userData[skin.hash] || { qty: 0, buyPrice: 0 };
                const priceCell = document.getElementById(`price-${index}`);
                const currentPrice = parseFloat(priceCell?.dataset?.price) || 0;

                const invested = saved.qty * saved.buyPrice;
                const revenueNet = (currentPrice * saved.qty) * 0.85; // Steam Fee
                const profit = revenueNet - invested;

                totalInvested += invested;
                if(currentPrice > 0) totalNetValue += revenueNet;

                // Update row profit
                const profitCell = document.getElementById(`profit-${index}`);
                if(profitCell && currentPrice > 0) {
                    profitCell.innerText = `${profit > 0 ? '+' : ''}${profit.toFixed(2)}â‚¬`;
                    profitCell.className = profit >= 0 ? 'profit-positive' : 'profit-negative';
                }
            });

            document.getElementById('total-invested').innerText = `${totalInvested.toFixed(2)}â‚¬`;
            document.getElementById('total-value').innerText = `${totalNetValue.toFixed(2)}â‚¬`;
            const profitTotal = totalNetValue - totalInvested;
            const totalSpan = document.getElementById('total-profit');
            totalSpan.innerText = `${profitTotal > 0 ? '+' : ''}${profitTotal.toFixed(2)}â‚¬`;
            totalSpan.style.color = profitTotal >= 0 ? '#4caf50' : '#f44336';
        }
    </script>
</body>
</html>



