<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>CS2 Skin Tracker PRO</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        /* ESTILOS GENERALES */
        body { font-family: 'Segoe UI', sans-serif; background-color: #1b2838; color: #c7d5e0; margin: 0; padding: 20px; display: flex; flex-direction: column; align-items: center; }
        h1 { color: #66c0f4; }
        button { cursor: pointer; border: none; border-radius: 4px; padding: 10px 15px; font-weight: bold; }
        input { background-color: #0d1015; border: 1px solid #4a6680; color: white; padding: 8px; border-radius: 4px; }

        /* --- SISTEMA DE VISIBILIDAD (A prueba de fallos) --- */
        /* 1. La clase .hidden tiene prioridad m√°xima */
        .hidden { display: none !important; }

        /* 2. Por defecto, todo oculto para evitar parpadeos o solapamientos */
        #auth-container, #app-container, #admin-panel { 
            display: none; 
        }

        /* 3. Solo mostramos si tienen expl√≠citamente la clase .visible */
        .visible { display: block !important; }

        /* PANTALLA DE CARGA */
        #loading-screen { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: #1b2838; z-index: 9999; display: flex; justify-content: center; align-items: center; color: #66c0f4; font-size: 1.5rem; }

        /* CONTENEDORES */
        #auth-container, #app-container { width: 100%; max-width: 900px; }

        /* AUTH & CONTROLS */
        .auth-box { background: #171a21; padding: 40px; border-radius: 8px; text-align: center; max-width: 400px; margin: 50px auto; box-shadow: 0 4px 15px rgba(0,0,0,0.5); }
        .auth-box input { width: 90%; margin-bottom: 15px; display: block; margin: 10px auto; }
        .auth-btn { background: linear-gradient(90deg, #47bfff 0%, #1a9fff 100%); color: white; width: 100%; }
        .top-bar { display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; }
        .refresh-btn { background: #4caf50; color: white; }
        .logout-btn { background: #d9534f; color: white; font-size: 0.8rem; }

        /* TABLA */
        .inventory-table { width: 100%; border-collapse: collapse; background-color: #171a21; border-radius: 8px; overflow: hidden; margin-bottom: 100px; }
        th, td { padding: 15px; text-align: left; border-bottom: 1px solid #2a475e; }
        th { background-color: #2a475e; color: #66c0f4; }
        .profit-positive { color: #4caf50; font-weight: bold; }
        .profit-negative { color: #f44336; font-weight: bold; }

        /* BOTONES EXTRA */
        .history-btn { background: #2a475e; color: #66c0f4; border: 1px solid #47bfff; padding: 5px 10px; font-size: 0.8rem; margin-left: 5px;}
        .delete-btn { background: #c9302c; color: white; padding: 5px 10px; font-size: 0.8rem; }

        /* MODAL GR√ÅFICA */
        #chart-modal { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.8); z-index: 1000; justify-content: center; align-items: center; }
        .chart-content { background: #1b2838; padding: 20px; border-radius: 8px; width: 90%; max-width: 800px; position: relative; }
        .close-chart { position: absolute; top: 10px; right: 15px; color: white; font-size: 24px; cursor: pointer; }

        /* ADMIN PANEL & SUMMARY */
        #admin-panel { background: #2a2d33; padding: 15px; margin-bottom: 20px; border-left: 4px solid #f0ad4e; }
        .admin-controls { display: flex; gap: 10px; margin-top: 10px; }
        .summary-bar { position: fixed; bottom: 0; left: 0; width: 100%; background-color: #101216; padding: 15px; display: flex; justify-content: center; gap: 30px; border-top: 2px solid #66c0f4; font-size: 1.2rem; z-index: 100; }
    </style>
</head>
<body>

    <div id="loading-screen">Cargando...</div>

    <div id="chart-modal">
        <div class="chart-content">
            <span class="close-chart" onclick="closeChart()">&times;</span>
            <canvas id="skinChart"></canvas>
        </div>
    </div>

    <div id="auth-container">
        <div class="auth-box">
            <h2>Bienvenido</h2>
            <input type="email" id="email" placeholder="Correo electr√≥nico">
            <input type="password" id="password" placeholder="Contrase√±a">
            <button class="auth-btn" onclick="handleLogin()">Iniciar Sesi√≥n</button>
            <button class="auth-btn" style="background: transparent; border: 1px solid #47bfff; margin-top: 10px;" onclick="handleRegister()">Registrarse</button>
            <p id="auth-msg" style="color: #f44336; margin-top: 10px;"></p>
        </div>
    </div>

    <div id="app-container">
        <div class="top-bar">
            <h1>Mi Cartera CS2</h1>
            <div>
                <span id="user-email" style="margin-right: 15px; color: #8f98a0;"></span>
                <button class="logout-btn" onclick="handleLogout()">Salir</button>
            </div>
        </div>

        <div id="admin-panel">
            <h3>üõ† Panel Administrador</h3>
            <div class="admin-controls">
                <input type="text" id="new-skin-name" placeholder="Nombre (ej: Revolution)">
                <input type="text" id="new-skin-hash" placeholder="Market Hash (ej: Revolution Case)">
                <button onclick="adminAddSkin()" style="background: #f0ad4e; color: black;">+ A√±adir Skin Global</button>
            </div>
        </div>

        <div style="display: flex; justify-content: flex-end; margin-bottom: 10px;">
            <button class="refresh-btn" onclick="actualizarPrecios()">üîÑ Actualizar Mercado</button>
        </div>

        <table class="inventory-table">
            <thead>
                <tr>
                    <th style="width: 30%">Skin</th>
                    <th>Cantidad</th>
                    <th>Compra Unit.</th>
                    <th>Precio Mercado</th>
                    <th>Beneficio</th>
                    <th>Hist√≥rico</th>
                    <th class="admin-only hidden">Acci√≥n</th>
                </tr>
            </thead>
            <tbody id="inventory-body"></tbody>
        </table>

        <div class="summary-bar">
            <div>Inv: <span id="total-invested">0.00‚Ç¨</span></div>
            <div>Valor: <span id="total-value">0.00‚Ç¨</span></div>
            <div>Profit: <span id="total-profit">0.00‚Ç¨</span></div>
        </div>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/9.23.0/firebase-app.js";
        // --- AQU√ç ESTABA EL ERROR: He quitado la coma sobrante ---
        import { 
    getAuth, 
    createUserWithEmailAndPassword, 
    signInWithEmailAndPassword, 
    signOut,
    onAuthStateChanged
} from "https://www.gstatic.com/firebasejs/9.23.0/firebase-auth.js";
        import { getFirestore, doc, getDoc, setDoc, collection, getDocs, addDoc, deleteDoc, query, orderBy, limit } from "https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore.js";

        // --- 1. PEGA AQU√ç TU CONFIGURACI√ìN DE FIREBASE ---
        const firebaseConfig = {
            apiKey: "AIzaSyDTrzjZAnrRhfWyJSBXnmPnc5cVMHhZPy0",
            authDomain: "calculadora2-a85c3.firebaseapp.com",
            projectId: "calculadora2-a85c3",
            storageBucket: "calculadora2-a85c3.firebasestorage.app",
            messagingSenderId: "1031799067800",
            appId: "1:1031799067800:web:2dbe67122cccf855e76ced",
            measurementId: "G-WE2ER7DP5K"
        };

        // --- CAMBIA ESTO POR TU EMAIL ---
        const ADMIN_EMAIL = "maksympavelko98@gmail.com"; 
        
        // INICIALIZACI√ìN
        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);

        let currentUser = null;
        let globalSkins = [];
        let userData = {};
        let chartInstance = null;

        // ---------------- AUTH ----------------
        window.handleLogin = async () => {
            try { await signInWithEmailAndPassword(auth, document.getElementById('email').value, document.getElementById('password').value); } 
            catch (e) { document.getElementById('auth-msg').innerText = "Error: " + e.message; }
        };
        window.handleRegister = async () => {
            try { await createUserWithEmailAndPassword(auth, document.getElementById('email').value, document.getElementById('password').value); } 
            catch (e) { document.getElementById('auth-msg').innerText = "Error: " + e.message; }
        };
        window.handleLogout = () => {
            document.getElementById('inventory-body').innerHTML = '';
            signOut(auth);
            window.location.reload(); // Recargar para limpiar todo bien
        };

        // --- SISTEMA DE VISIBILIDAD (Corregido) ---
        onAuthStateChanged(auth, async (user) => {
            const loadingScreen = document.getElementById('loading-screen');
            const authContainer = document.getElementById('auth-container');
            const appContainer = document.getElementById('app-container');
            const adminPanel = document.getElementById('admin-panel');
            const adminColumns = document.querySelectorAll('.admin-only');

            if (user) {
                // --- USUARIO LOGUEADO ---
                currentUser = user;
                try { document.getElementById('user-email').innerText = user.email; } catch(e){}

                // 1. Mostrar App y Ocultar Login
                appContainer.classList.add('visible');
                authContainer.classList.remove('visible');

                // 2. Panel Admin
                if(user.email === ADMIN_EMAIL) {
                    adminPanel.classList.add('visible');
                    adminColumns.forEach(el => el.classList.remove('hidden'));
                } else {
                    adminPanel.classList.remove('visible');
                    adminColumns.forEach(el => el.classList.add('hidden'));
                }

                await cargarDatosIniciales();

            } else {
                // --- USUARIO NO LOGUEADO ---
                currentUser = null;
                
                // 1. Mostrar Login y Ocultar App
                authContainer.classList.add('visible');
                appContainer.classList.remove('visible');
            }
            
            // Quitar pantalla de carga
            loadingScreen.style.display = 'none';
        });

        // ---------------- DATA ----------------
        async function cargarDatosIniciales() {
            try {
                const querySnapshot = await getDocs(collection(db, "skins"));
                globalSkins = [];
                querySnapshot.forEach((doc) => globalSkins.push({ id: doc.id, ...doc.data() }));

                const userDocRef = doc(db, "users", currentUser.uid);
                const userSnap = await getDoc(userDocRef);
                userData = userSnap.exists() ? userSnap.data().inventory || {} : {};

                renderTable();
            } catch (e) { console.error("Error cargando:", e); }
        }

        function renderTable() {
            const tbody = document.getElementById('inventory-body');
            tbody.innerHTML = '';
            const isAdmin = currentUser && currentUser.email === ADMIN_EMAIL;

            globalSkins.forEach((skin, index) => {
                const saved = userData[skin.hash] || { qty: 0, buyPrice: 0 };
                const row = document.createElement('tr');
                row.innerHTML = `
                    <td><strong>${skin.nombre}</strong><br><span style="font-size:0.75rem; color:#8f98a0;">${skin.hash}</span></td>
                    <td><input type="number" value="${saved.qty}" min="0" style="width:60px" onchange="window.saveInput('${skin.hash}', 'qty', this.value)"></td>
                    <td><input type="number" value="${saved.buyPrice}" step="0.01" min="0" style="width:70px" onchange="window.saveInput('${skin.hash}', 'buyPrice', this.value)"></td>
                    <td id="price-${index}" class="market-price" data-hash="${skin.hash}">---</td>
                    <td id="profit-${index}">---</td>
                    <td><button class="history-btn" onclick="window.showHistory('${skin.id}', '${skin.nombre}')">üìà Ver</button></td>
                    <td class="admin-only ${isAdmin ? '' : 'hidden'}"><button class="delete-btn" onclick="window.adminDeleteSkin('${skin.id}')">X</button></td>
                `;
                tbody.appendChild(row);
            });
            calcularTotales();
        }

        window.saveInput = async (hash, field, value) => {
            if (!userData[hash]) userData[hash] = { qty: 0, buyPrice: 0 };
            userData[hash][field] = parseFloat(value) || 0;
            try { await setDoc(doc(db, "users", currentUser.uid), { inventory: userData }, { merge: true }); calcularTotales(); } catch (e) {}
        };

        window.adminAddSkin = async () => {
            const nombre = document.getElementById('new-skin-name').value;
            const hash = document.getElementById('new-skin-hash').value;
            if(nombre && hash) {
                await addDoc(collection(db, "skins"), { nombre, hash });
                document.getElementById('new-skin-name').value = '';
                document.getElementById('new-skin-hash').value = '';
                await cargarDatosIniciales();
            }
        };

        window.adminDeleteSkin = async (id) => {
            if(confirm("¬øBorrar skin?")) { await deleteDoc(doc(db, "skins", id)); await cargarDatosIniciales(); }
        };

        // ---------------- GR√ÅFICAS ----------------
        window.showHistory = async (skinId, skinName) => {
            document.getElementById('chart-modal').style.display = 'flex';
            const ctx = document.getElementById('skinChart').getContext('2d');
            if (chartInstance) chartInstance.destroy();

            const q = query(collection(db, "skins", skinId, "history"), orderBy("date", "asc"), limit(50));
            const snapshot = await getDocs(q);
            const labels = [], dataPoints = [];

            snapshot.forEach(doc => {
                const d = doc.data();
                const dateObj = d.date.toDate ? d.date.toDate() : new Date(d.date);
                const dateStr = `${dateObj.getDate()}/${dateObj.getMonth()+1} ${dateObj.getHours()}:00`;
                labels.push(dateStr);
                dataPoints.push(d.price);
            });

            if(labels.length === 0) { labels.push("Sin datos"); dataPoints.push(0); }

            chartInstance = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: labels,
                    datasets: [{
                        label: `Precio: ${skinName}`,
                        data: dataPoints,
                        borderColor: '#47bfff',
                        backgroundColor: 'rgba(71, 191, 255, 0.1)',
                        tension: 0.3,
                        fill: true
                    }]
                },
                options: {
                    responsive: true,
                    plugins: { legend: { labels: { color: 'white' } } },
                    scales: {
                        y: { ticks: { color: '#8f98a0' }, grid: { color: '#2a475e' } },
                        x: { ticks: { color: '#8f98a0' }, grid: { color: '#2a475e' } }
                    }
                }
            });
        };
        window.closeChart = () => { document.getElementById('chart-modal').style.display = 'none'; };

        // ---------------- PRECIOS LIVE ----------------
        window.actualizarPrecios = async () => {
            const pricesCells = document.querySelectorAll('.market-price');
            pricesCells.forEach(cell => cell.innerHTML = '<span style="color:#f0ad4e">...</span>');
            for (let i = 0; i < globalSkins.length; i++) {
                const skin = globalSkins[i];
                const celda = document.getElementById(`price-${i}`);
                try {
                    const res = await fetch(`/api/price?skin=${encodeURIComponent(skin.hash)}`);
                    const data = await res.json();
                    if (data.lowest_price) {
                        let p = parseFloat(data.lowest_price.replace(/[^\d,.-]/g, '').replace(',','.'));
                        celda.dataset.price = p;
                        celda.innerText = `${p.toFixed(2)}‚Ç¨`;
                    } else celda.innerText = "N/A";
                } catch (e) { celda.innerText = "Err"; }
            }
            calcularTotales();
        }

        function calcularTotales() {
            let totalInvested = 0, totalNetValue = 0;
            globalSkins.forEach((skin, index) => {
                const saved = userData[skin.hash] || { qty: 0, buyPrice: 0 };
                const currentPrice = parseFloat(document.getElementById(`price-${index}`)?.dataset?.price) || 0;
                const invested = saved.qty * saved.buyPrice;
                const revenueNet = (currentPrice * saved.qty) * 0.85;
                const profit = revenueNet - invested;
                totalInvested += invested;
                if(currentPrice > 0) totalNetValue += revenueNet;
                
                const pCell = document.getElementById(`profit-${index}`);
                if(pCell && currentPrice > 0) {
                    pCell.innerText = `${profit > 0 ? '+' : ''}${profit.toFixed(2)}‚Ç¨`;
                    pCell.className = profit >= 0 ? 'profit-positive' : 'profit-negative';
                }
            });
            document.getElementById('total-invested').innerText = `${totalInvested.toFixed(2)}‚Ç¨`;
            document.getElementById('total-value').innerText = `${totalNetValue.toFixed(2)}‚Ç¨`;
            const profitTotal = totalNetValue - totalInvested;
            const tSpan = document.getElementById('total-profit');
            tSpan.innerText = `${profitTotal > 0 ? '+' : ''}${profitTotal.toFixed(2)}‚Ç¨`;
            tSpan.style.color = profitTotal >= 0 ? '#4caf50' : '#f44336';
        }
    </script>
</body>
</html>

